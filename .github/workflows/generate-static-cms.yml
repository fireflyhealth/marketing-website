name: Generate Static CMS
on:
  workflow_dispatch:
  repository_dispatch:
    types: [cms-generate-webhook]

jobs:
  Generate-Static-CMS:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/workflows/yarn-setup
      - name: get latest cms data
        run: yarn update-site-data
        env:
          NEXT_PUBLIC_SANITY_DATASET: production
      - name: build
        run: cd www && yarn build
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: generate latest cms locally"
          title: "[Sanity CMS Updates] Generate latest CMS locally"
          body: "This PR was generated by the workflow, indicating that the editor wishes to publish the latest content."
          branch: cms-updates
          base: production

  deploy-preview-with-static-cms:
    name: Preview
    runs-on: ubuntu-latest
    outputs:
      preview-url: ${{ steps.vercel.outputs.preview-url }}
    defaults:
      run:
        working-directory: 'www'
    steps:
      - uses: ./.github/workflows/yarn-setup
      - uses: actions/checkout@v3
      - uses: amondnet/vercel-action@v25
        id: vercel
        with:
          vercel-project-id: ${{ vars.VERCEL_PROJECT_ID }}
          vercel-org-id: ${{ vars.VERCEL_ORG_ID }}
          scope: ${{ vars.VERCEL_ORG_ID }}
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        env:
          STATIC_BUILD: true